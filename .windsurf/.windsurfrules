#  ðŸ¤– System Instructions: Next.js Architecture & Quality Standards

## ðŸš¨ MANDATOS ABSOLUTOS (NON-NEGOTIABLE)

1\.  \*\*Gestor de Paquetes\*\*: Usar \*\*exclusivamente \`pnpm\`\*\*.  
    \* âŒ Prohibido \`npm\` o \`yarn\`.  
    \* âŒ Prohibido modo PnP.  
    \* âš ï¸ Ejecutar \`pnpm audit\` si se detectan vulnerabilidades.  
2\.  \*\*Base de Datos & Integridad\*\*:  
    \* Usar \*\*Prisma ORM\*\*. Mantener sincronizado: \`npx prisma generate\`.  
    \* ðŸ”’ \*\*Seguridad\*\*: Implementar \*\*RLS (Row Level Security)\*\* en base de datos para cada tabla nueva.  
    \* âš¡ \*\*Concurrencia CrÃ­tica\*\*:  
        \* Usar \`prisma.$transaction\` para operaciones que toquen mÃºltiples tablas.  
        \* Implementar \*\*Optimistic Concurrency Control\*\* (campo \`@version\` en Prisma) para evitar "Race Conditions" en actualizaciones de saldo o inventario.  
3\.  \*\*Workflow de Calidad\*\*:  
    \* \*\*Inicio\*\*: Verificar plugins de \*\*SonarQube\*\* y \*\*Codacy\*\*.  
    \* \*\*Final\*\*: Validar \`pnpm lint\`, \`tsc \--noEmit\`, \`pnpm build\`. Todo en Verde.  
4\.  \*\*Regla de Oro de Testing\*\*:  
    \* ðŸ›‘ Si cÃ³digo nuevo rompe un test: \*\*CORRIGE EL CÃ“DIGO, NUNCA EL TEST\*\*.  
    \* JamÃ¡s modificar la lÃ³gica de un test para falsear el resultado.  
5\.  \*\*DocumentaciÃ³n\*\*:  
    \* âœ… Solo Features Nuevas.  
    \* âŒ NO documentar bug fixes.  
    \* i18n siempre sincronizado.

\---

## ðŸ—ï¸ Principios de Arquitectura (Next.js Edition)

### OrganizaciÃ³n del CÃ³digo

\* \*\*Feature-First\*\*: Organizar en \`src/features/\` (ej: \`auth\`, \`wallet\`, \`network\`).  
\* \*\*Clean Architecture\*\*:  
    \* \*\*Data\*\*: DTOs, Zod Schemas, Prisma Repository.  
    \* \*\*Domain\*\*: Business Logic pura, Custom Hooks.  
    \* \*\*Presentation\*\*: UI Components, Pages.  
\* \*\*SeparaciÃ³n de Responsabilidades\*\*:  
    \* Server Components (Data/Security) vs Client Components (Interaction).  
\* \*\*InyecciÃ³n de Dependencias\*\*: Evitar hardcoding; usar Context/Props.

### Patrones de DiseÃ±o Obligatorios

\* \*\*Repository Pattern\*\*: AbstracciÃ³n de BD (\`orders.repository.ts\`).  
\* \*\*Server Actions (Command Pattern)\*\*: Mutaciones seguras.  
\* \*\*Factory Pattern\*\*: GeneraciÃ³n dinÃ¡mica de UI.  
\* \*\*Observer Pattern\*\*: Suscripciones reactivas.  
\* \*\*Error Boundary\*\*: \`error.tsx\` en cada ruta.

### UX Mobile-First & PWA

\* \*\*DiseÃ±o\*\*: Mobile-First (Base 320px). Breakpoints: 768px, 1024px.  
\* \*\*Touch Targets\*\*: MÃ­nimo \*\*44px x 44px\*\*.  
\* \*\*UI States\*\*: Loading (Skeletons), Empty (Ilustraciones), Error (Recoverable).  
\* \*\*PWA\*\*: Service Worker (Cache Offline), Manifest completo, "Pull to Refresh".

\---

##  ðŸ”’ Seguridad Robusta & Uploads

### ProtecciÃ³n de Archivos (Anti-Malware)

\* \*\*Escaneo Obligatorio\*\*: NINGÃšN archivo subido por el usuario debe procesarse sin ser escaneado.  
\* \*\*Protocolo de Escaneo\*\*:  
    1\.  \*\*Verificar ConfiguraciÃ³n\*\*: Buscar \`VIRUSTOTAL\_API\_KEY\` en \`.env\`.  
    2\.  \*\*OpciÃ³n A (Con API)\*\*: Si existe la key, implementar chequeo contra VirusTotal API antes de mover el archivo a almacenamiento permanente.  
    3\.  \*\*OpciÃ³n B (Sin API)\*\*: Si no estÃ¡ configurado, implementar soluciÃ³n automÃ¡tica server-side (ej: contenedor con \*\*ClamAV\*\* o funciÃ³n Lambda/Edge de escaneo).  
    4\.  \*\*Cuarentena\*\*: Los archivos se suben primero a un bucket "Temp/Quarantine". Solo pasan a "Clean" tras resultado negativo de virus.

### ConfiguraciÃ³n y Ataques

\* \*\*Zero Hardcoding\*\*: Todo a \`.env\`. Validar con Zod al inicio.  
\* \*\*Input Validation\*\*: Zod estricto en todos los inputs.  
\* \*\*Rate Limiting\*\*: ProtecciÃ³n contra DDoS/Brute Force en Server Actions.  
\* \*\*SanitizaciÃ³n\*\*: DOMPurify si se inyecta HTML.  
\* \*\*Headers\*\*: CSP, HSTS, X-Content-Type-Options.

\---

## ðŸ§  Estructura de Proyecto y SEO

### Estructura Predecible

\`\`\`text  
src/  
  app/                 \# Rutas App Router  
  features/            \# MÃ³dulos de Negocio  
  lib/  
    antivirus/         \# LÃ³gica de escaneo (VirusTotal/ClamAV)  
    db/                \# Prisma Client  
  types/               \# Tipos globales

## SEO TÃ©cnico & A11y

 \* SemÃ¡ntica: HTML5 Estricto.  
 \* Metadata: TÃ­tulos dinÃ¡micos, Open Graph, Twitter Cards.  
 \* Schema.org: JSON-LD (Product, Organization).  
 \* A11y: WCAG 2.1 AA (Contraste, Aria-labels, Alt texts).  
ðŸ›¡ï¸ ValidaciÃ³n y Tipos  
 \* Type Safety: TypeScript Strict. Prohibido any.  
 \* Contratos: Esquemas Zod sincronizados (Front-Back-DB).  
 \* Errores: try/catch con tipos de error personalizados.  
ðŸ§ª Testing y Calidad  
Cobertura  
 \* Unit: \>80% en lÃ³gica de negocio.  
 \* Integration: Testear flujo completo (Upload \-\> Scan \-\> Save).  
 \* Mobile: Simular 3G, Touch, OrientaciÃ³n.  
AnÃ¡lisis EstÃ¡tico  
 \* SonarQube: 0 Code Smells CrÃ­ticos.  
 \* Codacy: Calidad A/B.  
 \* pnpm audit antes de deploy.

## ðŸ”„ CI/CD

 \* Pipeline: Lint \-\> TypeCheck \-\> Build \-\> Test \-\> Security Audit.  
 \* Deploy: AutomÃ¡tico solo si pasa todo.

## ðŸŽ¯ FilosofÃ­a Central para IA

 \* Seguridad Primero: Asumir que todo input (texto o archivo) es malicioso hasta probar lo contrario.  
 \* Integridad de Datos: Nunca permitir condiciones de carrera (Race Conditions) en transacciones financieras o de inventario.  
 \* Claridad: CÃ³digo auto-explicativo y documentado (solo features nuevas).